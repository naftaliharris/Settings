#!/bin/bash

PWFILE=/home/naftali/keys/passwords.tsv

control_c()
{
  echo "*** Shredding Password File ***"
  shred -u $PWFILE
  exit -1
}
 
# trap keyboard interrupt (control-c)
trap control_c SIGINT

echo -n "Enter Password: "
read -s PASSWORD
echo ""
echo $PASSWORD | gpg --passphrase-fd 0 ${PWFILE}.gpg
if [[ $? -ne 0 ]]
then
    exit -1
fi

echo -n "Name the new service: "
read service
new_pass=$(pwgen)

echo -e "${service}\t${new_pass}" >> $PWFILE

success=1
while [[ $success -ne 0 ]]
do
    echo $PASSWORD | sudo gpg -c --passphrase-fd 0 ${PWFILE}
    success=$?
done
echo -n $new_pass | xclip -selection clipboard

shred -u $PWFILE
exit 0
